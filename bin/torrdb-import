#!/usr/bin/env node
const client = require('../lib/elasticsearch.js')
const defaults = require('../lib/defaults.js')
const pouchdb = require('pouchdb')

const db = pouchdb(
  'http://torrdb.less.center:5984/torrent',
  {revs_limit: 1}
);

let count = 0

async function bulk(documents) {
  const body = documents.reduce((body, torrent) => {
    body.push(
      {
        index: {
          _index: defaults.index,
          _type:  'torrent',
          _id:    torrent._id,
        }
      },
      {
        name:     torrent.name,
        magnet:   torrent.magnet,
        extnames: torrent.extnames
      }
    )
    return body
  }, [])
  const response = await client.bulk({body})
  count += response.items.length
  console.log(`${count} documents saved`);
  return response
}

db.changes({
  since: 'now',
  live: true,
  include_docs: true
})
.on('change', async function(change) {
  await bulk([change.doc])
})
.on('error', (error) => {
  console.error(error.stack);
})

async function all() {
  const limit = 10000
  let since = 0
  let changes
  do {
    changes = await db.changes({since, limit, include_docs: true})
    since = changes.last_seq
    const documents = changes.results.map(result => result.doc)
    await bulk(documents)
  } while (changes.results.length >= limit);
}

all()
